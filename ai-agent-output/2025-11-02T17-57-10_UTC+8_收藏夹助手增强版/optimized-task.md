# 优化后的任务描述

## 背景
现有 `auto_download_favlist` 模块提供 Typer 子命令用于导出收藏夹 CSV，但缺乏交互式入口及收藏配置管理。需新增一个 CLI 助手以便录入、复用收藏夹配置，并辅助下载缺失视频。

## 目标
- 提供 `bilibili_favlist_download_helper` 可执行入口，运行后以交互式方式操作。
- 支持录入新收藏夹信息并立即抓取收藏夹 CSV，文件名格式为 `yyyy-MM-ddThh-mm-ss-favlist.csv`。
- 支持读取、编辑历史配置，执行“检查更新”或“检查缺漏”两类动作。
- 在“检查更新”与“检查缺漏”流程中调用 `bbdown <bvid> --work-dir <本地目录>`（支持 `--dry-run`）。

## 已确认约束与方案
- **配置存储**：使用 JSON 文件写入 `~/.config/bilibili_favlist_helper/config.json`（若存在 `XDG_CONFIG_HOME` 则优先）。字段包含收藏夹 URL、下载目录、最新 CSV 路径、最近抓取时间等。
- **CSV 存储**：默认保存在下载目录内；生成前确保目录存在，失败时给出友好提示。
- **bbdown 调用**：通过 `subprocess.run` 执行，默认真实下载；在 `--dry-run` 模式下仅打印待执行命令。
- **流程记录**：交互命令过程中输出明确提示，出现异常时提供修复建议并返回非零码。

## 执行步骤（预期顺序）
1. 编写配置读写与数据结构模块，封装 JSON 序列化逻辑。
2. 封装调用 `auto_download_favlist` 导出 CSV 的服务函数，负责生成时间戳文件名与异常处理。
3. 设计交互式 CLI 主流程：主菜单、录入流程、历史配置操作（编辑/检查更新/检查缺漏）。
4. 实现“检查更新”逻辑：备份旧 CSV、调用抓取、比对新增条目、逐条执行（或打印）`bbdown`。
5. 实现“检查缺漏”逻辑：枚举下载目录的视频文件、解析 BV 号、对比 CSV 中的 `bv_id` 列并下载缺失项目。
6. 提供 `--dry-run` 全局选项并在关键操作输出预期命令。
7. 编写或更新测试（如 CLI 单元测试/功能测试脚本）。
8. 更新相关文档、变更日志并整理交付物。

## 验证标准
- 交互流程可完成：录入测试收藏夹、生成 CSV、保存配置；使用历史配置执行编辑、检查更新、检查缺漏。
- 在 `--dry-run` 下不实际执行 `bbdown`，输出拟执行命令；正常模式可检测到命令缺失并提示。
- CSV 备份文件按要求添加 `.backup.csv` 后缀，比较逻辑输出新增条目列表。
- 缺漏检查可识别目录中文件名内的 BV 号，列出缺失条目并触发 `bbdown`。
- 所有异常路径提供友好提示并返回非零退出码。

## 文档与交付要求
- 产出流程设计文档与 PlantUML 流程图 PNG（存放在 `program_flowchart/png`）。
- 按流程更新 `AI-AGENT_working-status.csv`、`undetermined.md` 与 `optimized-task.md`。
- 在“文档更新”环节维护 `CHANGELOG.md` 新版本段落并重建 `[Unreleased]` 块。

## 风险与应对
- `bbdown` 缺失：捕获 `FileNotFoundError` 并提示安装或使用 `--dry-run` 模式。
- 网络/API 异常：沿用现有模块异常类型，提供重试建议。
- CSV 结构变化：读取时容错列名，必要时记录警告并继续。

## 验证结果
- 2025-11-02T18:58:20+08:00 执行 `pytest` 全量用例，11 项全部通过，覆盖配置仓库、导出服务、BV 扫描逻辑及原有 CLI。
