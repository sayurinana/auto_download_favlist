# 优化后的任务描述

## 背景
- `bilibili_favlist_download_helper` 已支持双路径配置与进度展示，但启动 BBDown 时默认工作目录未统一，且缺漏补全阶段无法限制同时运行的下载任务数量。
- 用户希望通过全局配置统一 BBDown 工作目录，并对任务并发进行控制，以免过载。

## 目标
1. 新增全局默认工作目录配置，启动 BBDown serve 或运行单个 `bbdown` 命令时自动应用。
2. 在缺漏补全流程中限制任务并发数：
   - 若当前运行中任务数达上限，则轮询等待直至低于上限，再提交新任务。
   - 全局配置可设定默认并发数，单个收藏夹配置可覆盖。
3. 保持现有功能兼容（包括 Windows/WSL 路径映射、dry-run 模式）。

## 交付物
- 代码更新：
  - `config.rs`：全局默认结构新增 `bbdown_work_dir`、`bbdown_max_concurrency`，FavConfig 添加对应字段，迁移旧配置。
  - `bbdown.rs`：启动/命令执行时应用工作目录；任务轮询逻辑支持目标列表与并发控制接口。
  - `main.rs`：
    - 录入/编辑流程提示默认工作目录、并发限制。
    - 缺漏补全流程根据限制批量提交任务；在运行中数量达到限制时等待并刷新提示。
    - 全局默认菜单支持新字段。
- 文档更新：`CHANGELOG.md`、`AI-AGENT_working-status.csv` 等记录。
- 测试：`cargo fmt`、`cargo test`、`cargo clippy --all-targets --all-features -- -D warnings`，并保留手动流程日志。

## 执行步骤
1. **配置层扩展**：在 `GlobalDefaults`/`FavConfig` 增加新字段，完成 JSON 序列化、默认填充。
2. **工作目录应用**：
   - `run_bbdown`/`start_bbdown_serve` 读取配置提供的工作目录；WSL 下转换为挂载路径，Windows 下直接使用。
3. **并发限制实现**：
   - 在缺漏补全过程根据配置计算上限；每次提交前查询 `/get-tasks/running`。
   - 若达到上限，显示等待提示并轮询直至可用。
   - 将提交队列划分为批次，完成一批后再查询下一批。
   - 继续使用 `wait_until_idle` 确认所有目标完成。
4. **界面与记录**：更新提示信息、全局默认菜单以及运行过程日志。
5. **测试与验证**：运行自动化测试；可选地进行一次真实缺漏补全验证（需用户环境支持）。
6. **文档更新与收尾**。

## 验证标准
- 启动 BBDown serve 时若配置了工作目录，则 Powershell/子进程均以该目录为当前目录（dry-run 打印指令确认）。
- 并发限制生效：若上限为 N，补缺流程在任何时间点最多有 N 个 running 任务；达到上限后输出等待信息。
- 当任务完成后，继续提交剩余任务直至所有缺漏处理完毕。
- 自动化测试与 Clippy 全部通过；文档记录完整。
