# 规范守则 - 高性能与分布式计算

## 项目类型
- 数值计算、科学模拟、批量数据处理、分布式训练、流式计算框架
- 交付形态：单机加速库（Numba/Cython）、集群调度（Ray、Dask、Spark）、GPU/TPU任务

## 核心优化策略
### 1. 算法与数据结构
- 优先选择向量化实现（NumPy/Array API），当热点函数仍慢时，再引入`numba`/`cython`。
- 关注内存局部性与Cache行对齐，避免频繁的Python对象分配。
- 对需要跨语言扩展的模块，使用`pybind11`或`cffi`暴露C/C++/Rust实现。

### 2. 性能调优
- 参考[Numba Performance Tips](https://numba.readthedocs.io/en/stable/user/performance-tips.html)配置`@njit`、并行与缓存参数。
- 使用`line_profiler`、`scalene`定位热点；将 profiling 脚本纳入CI的性能预算检查。
- 记录每次优化的基准与环境，以避免回归（Benchmark CI + `asv`）。
### 3. 分布式作业调度
- 设计任务切分策略：数据并行（批次划分）、模型并行（层/权重分片）、流水线并行。
- 对跨节点通信使用零拷贝传输（PyArrow Plasma、UCX），减少序列化开销。
- 采用[Ray Serve最佳实践](https://docs.ray.io/en/latest/serve/production-guide/best-practices.html)管理部署：自动扩缩容、路由与熔断策略。
- 在多租户场景下，对资源施加限额（Kubernetes ResourceQuota＋Ray autoscaler），防止任务互相抢占。

## 工程结构示例
```
hpc_app/
├── pyproject.toml
├── hpc_app/
│   ├── __init__.py
│   ├── config.py
│   ├── kernels.py       # numba/cython加速函数
│   ├── pipelines.py     # Ray/Dask图定义
│   ├── storage.py       # 数据读写
│   └── monitoring.py
├── scripts/
│   └── launch_ray_cluster.py
└── benchmarks/
    ├── bench_kernels.py
    └── bench_end_to_end.py
```
## 测试与可靠性
- 单元测试：将核心算法分离，在无并行环境下验证边界条件与稳定性。
- 基准测试：使用`pytest-benchmark`或`asv`记录性能基线，CI对比允许的波动范围。
- 故障演练：模拟节点宕机、网络分区，通过Ray/Dask的容错机制验证可恢复能力。
- 资源监控：采集GPU/CPU/内存指标，建立自动扩缩容策略；对长尾任务启用超时/重试。
- 安全：在共享集群中隔离虚拟环境，禁用任意代码注入，监控数据泄漏路径。

## 参考资料
- [Numba Performance Tips](https://numba.readthedocs.io/en/stable/user/performance-tips.html) - JIT加速优化指南。
- [Ray Serve Production Best Practices](https://docs.ray.io/en/latest/serve/production-guide/best-practices.html) - 分布式推理服务部署建议。
- [OpenTelemetry Python Instrumentation](https://opentelemetry.io/docs/languages/python/instrumentation/) - 分布式作业链路观测标准。
- [Google SRE Workbook: Eliminating Toil](https://sre.google/workbook/eliminating-toil/) - 对批处理与集群运维的自动化改进原则。
