# AI_AGENT.md - 库项目规范守则

这是针对Rust库(crate)开发的通用AI代理规范守则文档。

## 项目类型
Rust库/框架(Library/Framework)

## 核心要求

### API设计原则
- 遵循Rust API设计指南
- 保持接口简洁和一致性
- 使用构建器模式处理复杂配置
- 提供零成本抽象
- 考虑向后兼容性

### 错误处理
- 定义清晰的错误类型体系
- 使用`thiserror`定义错误类型
- 为错误提供恢复策略
- 避免在库代码中使用`panic!`

### 内存和性能
- 优化热路径代码
- 避免不必要的分配和拷贝
- 使用适当的生命周期参数
- 提供异步和同步两种API（如适用）

### 特性管理
- 使用feature gates控制可选功能
- 保持默认feature集合最小
- 清楚标注实验性API

## 必需依赖
```toml
[dependencies]
thiserror = "1.0"

[dev-dependencies]
criterion = "0.5"
proptest = "1.0"
```

## 推荐依赖
```toml
# 序列化支持（可选）
serde = { version = "1.0", features = ["derive"], optional = true }

# 异步支持（可选）
tokio = { version = "1.0", features = ["rt"], optional = true }
futures = { version = "0.3", optional = true }

# 日期时间（如需要）
chrono = { version = "0.4", optional = true }
```

## 特性配置
```toml
[features]
default = []
serde = ["dep:serde"]
async = ["tokio", "futures"]
full = ["serde", "async"]
```

## 项目结构
```
src/
├── lib.rs           # 库入口，公共API
├── error.rs         # 错误类型定义
├── config.rs        # 配置相关类型
├── core/            # 核心功能模块
│   ├── mod.rs
│   ├── processor.rs
│   └── builder.rs
├── utils/           # 工具函数
│   ├── mod.rs
│   └── helpers.rs
└── async_impl.rs    # 异步实现（feature gated）
```

## 代码模板

### lib.rs结构
```rust
//! # 库名称
//! 
//! 库的简短描述
//! 
//! ## 特性
//! 
//! - `serde` - 序列化支持
//! - `async` - 异步API支持
//! 
//! ## 示例
//! 
//! ```rust
//! use mylib::Builder;
//! 
//! let result = Builder::new()
//!     .with_option(value)
//!     .build()?;
//! ```

#![deny(missing_docs)]
#![warn(clippy::all)]
#![cfg_attr(docsrs, feature(doc_cfg))]

pub mod error;
mod core;

#[cfg(feature = "async")]
#[cfg_attr(docsrs, doc(cfg(feature = "async")))]
pub mod async_impl;

pub use error::{Error, Result};
pub use core::{Builder, Processor};

/// 库版本
pub const VERSION: &str = env!("CARGO_PKG_VERSION");
```

### 错误类型定义
```rust
use thiserror::Error;

/// 库的错误类型
#[derive(Error, Debug)]
pub enum Error {
    /// 配置错误
    #[error("配置无效: {message}")]
    InvalidConfig { message: String },
    
    /// I/O错误
    #[error("I/O操作失败")]
    Io(#[from] std::io::Error),
    
    /// 解析错误
    #[error("解析失败: {0}")]
    Parse(String),
}

/// 库的Result类型别名
pub type Result<T> = std::result::Result<T, Error>;
```

### 构建器模式
```rust
/// 配置构建器
#[derive(Debug)]
pub struct Builder {
    config: Config,
}

impl Builder {
    /// 创建新的构建器
    pub fn new() -> Self {
        Self {
            config: Config::default(),
        }
    }
    
    /// 设置选项
    pub fn with_option(mut self, value: String) -> Self {
        self.config.option = Some(value);
        self
    }
    
    /// 构建最终对象
    pub fn build(self) -> Result<Processor> {
        self.config.validate()?;
        Ok(Processor::new(self.config))
    }
}

impl Default for Builder {
    fn default() -> Self {
        Self::new()
    }
}
```

## 文档要求
- 所有公共API必须有文档注释
- 提供完整的使用示例
- 使用`#[doc(cfg(...))]`标记feature-gated项目
- 在README中说明所有features
- 提供migration guide（版本升级时）

## 测试策略
- 使用proptest进行基于属性的测试
- 提供集成测试验证公共API
- 使用criterion进行性能基准测试
- 测试所有feature组合

## API稳定性
- 公共API变更遵循SemVer
- 使用`#[deprecated]`标记废弃API
- 提供迁移路径和时间表
- 在CHANGELOG中详细记录破坏性变更

## 发布检查清单
- [ ] 所有examples可以运行
- [ ] 文档生成无警告
- [ ] 所有feature组合测试通过
- [ ] 基准测试无性能退化
- [ ] 更新版本号和CHANGELOG
